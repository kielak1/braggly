#!/bin/bash
# Ustawienia

BASE_URL="http://localhost:9191"
USERNAME="admin"
PASSWORD="admin"

# 1. Pobranie tokena

TOKEN=$(curl -s -X POST "$BASE_URL/api/auth/login"  -H "Content-Type: application/json"  -d "{\"username\": \"$USERNAME\", \"password\": \"$PASSWORD\"}" | jq -r '.token')

# Sprawdzenie czy token zostaÅ‚ pobrany
if [ "$TOKEN" == "null" ] || [ -z "$TOKEN" ]; then
    echo "âŒ BÅ‚Ä…d: Nie udaÅ‚o siÄ™ pobraÄ‡ tokena!"
    exit 1
fi

echo "âœ… Token pobrany: $TOKEN"


# 7. UÅ¼ycie tokena do wywoÅ‚ania /api/list-user

USER_LIST=$(curl -s -X GET "$BASE_URL/api/admin/list-user" -H "Authorization: Bearer $TOKEN")
echo "ğŸ” OdpowiedÅº z /api/list-user: $USER_LIST"

# 8. Pobranie ID pierwszego uÅ¼ytkownika z listy zwrÃ³conej w JSON
USER_ID=$(echo "$USER_LIST" | jq -r '.[1].id')

if [ "$USER_ID" == "null" ] || [ -z "$USER_ID" ]; then
    echo "âŒ BÅ‚Ä…d: Nie udaÅ‚o siÄ™ pobraÄ‡ ID uÅ¼ytkownika!"
    exit 1
fi

echo "ğŸ“Œ ZapamiÄ™tane ID uÅ¼ytkownika: $USER_ID"

# 9. Pobranie numeru pakietu do dodania do uÅ¼ytkownika
PACKAGE_ID=$(curl -s -X GET "$BASE_URL/credits/packages" -H "Authorization: Bearer $TOKEN" | jq -r '.[0].id')

echo "ğŸ” OdpowiedÅº z /credits/packages: $(curl -s -X GET "$BASE_URL/credits/packages" -H "Authorization: Bearer $TOKEN")"

if [ "$PACKAGE_ID" == "null" ] || [ -z "$PACKAGE_ID" ]; then
    echo "âŒ BÅ‚Ä…d: Nie udaÅ‚o siÄ™ pobraÄ‡ ID pakietu!"
    exit 1
fi

echo "ğŸ“Œ ZapamiÄ™tany ID pakietu do dodania : $PACKAGE_ID do uÅ¼ytkownika $USER_ID"

# 10. Przypisanie kredytÃ³w uÅ¼ytkownikowi

# JSON_PAYLOAD="{\"userId\": \"$USER_ID\", \"packageId\": \"$PACKAGE_ID\"}"
# echo "ğŸ“¦ JSON wysyÅ‚any w Å¼Ä…daniu: $JSON_PAYLOAD"

# RESPONSE=$(curl -s -v -X POST "$BASE_URL/credits/assign" \
#   -H "Authorization: Bearer $TOKEN"  \
#   -H "Content-Type: application/json" \
#   -d "$JSON_PAYLOAD")

RESPONSE=$(curl -s -v -X POST "$BASE_URL/credits/assign" \
  -H "Authorization: Bearer $TOKEN"  \
  -H "Content-Type: application/x-www-form-urlencoded" \
  --data "userId=$USER_ID&packageId=$PACKAGE_ID")


echo "ğŸ¯ OdpowiedÅº z przypisania kredytÃ³w uÅ¼ytkownikowi: $RESPONSE"
