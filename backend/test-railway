#!/bin/bash

# Ustawienia
BASE_URL="https://bragglybackend.kielak.com"
USERNAME="admin"
PASSWORD="admin"

# 1. Pobranie tokena
TOKEN=$(curl -s -X POST "$BASE_URL/api/auth/login" \
  -H "Content-Type: application/json" \
  -d "{\"username\": \"$USERNAME\", \"password\": \"$PASSWORD\"}" | jq -r '.token')

if [ "$TOKEN" == "null" ] || [ -z "$TOKEN" ]; then
    echo "âŒ BÅ‚Ä…d: Nie udaÅ‚o siÄ™ pobraÄ‡ tokena!"
    exit 1
fi

echo "âœ… Token pobrany: $TOKEN"

# 2. WywoÅ‚anie /api/hello
RESPONSE=$(curl -s -X GET "$BASE_URL/api/hello" -H "Authorization: Bearer $TOKEN")
echo "ğŸ” OdpowiedÅº z /api/hello: $RESPONSE"

# 3. Dodanie pakietu kredytowego
NEW_PACKAGE='{"credits": 5, "priceInCents": 45}'
RESPONSE=$(curl -s -X POST "$BASE_URL/credits/packages"  -H "Authorization: Bearer $TOKEN"  -H "Content-Type: application/json"  -d "$NEW_PACKAGE")
echo "ğŸ†• OdpowiedÅº z dodania pakietu: $RESPONSE"

# 4. Pobranie ID pierwszego pakietu
PACKAGE_ID=$(curl -s -X GET "$BASE_URL/credits/packages" -H "Authorization: Bearer $TOKEN" | jq -r '.[0].id')
if [ "$PACKAGE_ID" == "null" ] || [ -z "$PACKAGE_ID" ]; then
    echo "âŒ BÅ‚Ä…d: Nie udaÅ‚o siÄ™ pobraÄ‡ ID pakietu!"
    exit 1
fi
echo "ğŸ“Œ ZapamiÄ™tany ID pakietu: $PACKAGE_ID"

# 5. UsuniÄ™cie pakietu kredytowego
RESPONSE=$(curl -s -X DELETE "$BASE_URL/credits/packages/$PACKAGE_ID" -H "Authorization: Bearer $TOKEN")
echo "ğŸ—‘ï¸ OdpowiedÅº z usuniÄ™cia pakietu: $RESPONSE"

# 6. Ponowne pobranie listy pakietÃ³w
RESPONSE=$(curl -s -X GET "$BASE_URL/credits/packages" -H "Authorization: Bearer $TOKEN")
echo "ğŸ” OdpowiedÅº z /credits/packages po usuniÄ™ciu: $RESPONSE"

# 7. Pobranie listy uÅ¼ytkownikÃ³w
USER_LIST=$(curl -s -X GET "$BASE_URL/api/admin/list-user" -H "Authorization: Bearer $TOKEN")
echo "ğŸ” OdpowiedÅº z /api/list-user: $USER_LIST"

# 8. Pobranie ID pierwszego uÅ¼ytkownika
USER_ID=$(echo "$USER_LIST" | jq -r '.[1].id')
if [ "$USER_ID" == "null" ] || [ -z "$USER_ID" ]; then
    echo "âŒ BÅ‚Ä…d: Nie udaÅ‚o siÄ™ pobraÄ‡ ID uÅ¼ytkownika!"
    exit 1
fi
echo "ğŸ“Œ ZapamiÄ™tane ID uÅ¼ytkownika: $USER_ID"

# 9. Pobranie ID pakietu do przypisania
PACKAGE_ID=$(curl -s -X GET "$BASE_URL/credits/packages" -H "Authorization: Bearer $TOKEN" | jq -r '.[0].id')
if [ "$PACKAGE_ID" == "null" ] || [ -z "$PACKAGE_ID" ]; then
    echo "âŒ BÅ‚Ä…d: Nie udaÅ‚o siÄ™ pobraÄ‡ ID pakietu!"
    exit 1
fi
echo "ğŸ“Œ Pakiet ID: $PACKAGE_ID zostanie przypisany uÅ¼ytkownikowi $USER_ID"

# 10. Przypisanie kredytÃ³w uÅ¼ytkownikowi
RESPONSE=$(curl -s -X POST "$BASE_URL/credits/assign" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  --data "userId=$USER_ID&packageId=$PACKAGE_ID")
echo "ğŸ¯ OdpowiedÅº z przypisania kredytÃ³w: $RESPONSE"

# 11. Pobranie historii zakupÃ³w kredytowych
PURCHASE_HISTORY=$(curl -s -X GET "$BASE_URL/credits/purchase-history?userId=$USER_ID" -H "Authorization: Bearer $TOKEN")
echo "ğŸ“œ Historia zakupÃ³w uÅ¼ytkownika ($USER_ID): $PURCHASE_HISTORY"

# 12. Pobranie historii uÅ¼ycia kredytÃ³w
USAGE_HISTORY=$(curl -s -X GET "$BASE_URL/credits/usage-history?userId=$USER_ID" -H "Authorization: Bearer $TOKEN")
echo "ğŸ“œ Historia uÅ¼ycia kredytÃ³w uÅ¼ytkownika ($USER_ID): $USAGE_HISTORY"